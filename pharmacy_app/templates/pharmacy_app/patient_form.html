{% extends "base.html" %}

{% block title %}
    {% if patient %}Edit {{ patient.first_name }} {{ patient.last_name }}{% else %}Add New Patient{% endif %} | PharmaLog
{% endblock title %}

{% block content %}
<div class="max-w-3xl mx-auto bg-white p-8 rounded-2xl shadow-2xl border border-indigo-100">
    <h1 class="text-3xl font-bold text-center mb-8 
        {% if patient %}text-yellow-700{% else %}text-indigo-700{% endif %}">
        {% if patient %}
            Edit Patient Record: {{ patient.first_name }} {{ patient.last_name }}
        {% else %}
            Add New Patient Record
        {% endif %}
    </h1>

    <form method="post" class="space-y-6">
        {% csrf_token %}

        {% for field in form %}
        <div class="grid grid-cols-1 gap-2">
            <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-gray-700">
                {{ field.label }}{% if field.field.required %} <span class="text-red-500">*</span>{% endif %}
            </label>
            
            {{ field.errors }}
            {{ field }}
            
            {% if field.help_text %}
                <p class="text-xs text-gray-500 mt-1">{{ field.help_text }}</p>
            {% endif %}
        </div>
    {% endfor %}

        {% if patient %}
            {% if perms.pharmacy_app.change_patient or perms.pharmacy_app.change_patient_medications %}
                <!-- allowed to submit -->
            {% else %}
                {% comment %} fallthrough to disabled below {% endcomment %}
            {% endif %}
        {% else %}
            {% if perms.pharmacy_app.add_patient %}
                <!-- allowed to submit -->
            {% endif %}
        {% endif %}
    {% comment %} Show submit button only if user is superuser or has the right perms {% endcomment %}
    {% if request.user.is_superuser %}
    <button type="submit" 
        class="w-full py-3 px-4 border border-transparent rounded-xl shadow-lg text-white font-semibold 
               {% if patient %}bg-yellow-600 hover:bg-yellow-700{% else %}bg-indigo-600 hover:bg-indigo-700{% endif %} 
               focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 transform hover:scale-[1.01]">
        {% if patient %}Save Changes{% else %}Create Patient Record{% endif %}
    </button>
    {% elif patient %}
        {% if perms.pharmacy_app.change_patient or perms.pharmacy_app.change_patient_medications %}
        <button type="submit" 
            class="w-full py-3 px-4 border border-transparent rounded-xl shadow-lg text-white font-semibold 
                   bg-yellow-600 hover:bg-yellow-700 
                   focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 transform hover:scale-[1.01]">
            Save Changes
        </button>
        {% else %}
        <div class="text-center text-gray-600 p-4">You do not have permission to make changes to this record.</div>
        {% endif %}
    {% elif not patient %}
        {% if perms.pharmacy_app.add_patient %}
        <button type="submit" 
            class="w-full py-3 px-4 border border-transparent rounded-xl shadow-lg text-white font-semibold bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 transform hover:scale-[1.01]">
            Create Patient Record
        </button>
        {% else %}
        <div class="text-center text-gray-600 p-4">You do not have permission to make changes to this record.</div>
        {% endif %}
    {% endif %}
    </form>
    
    <div class="mt-6 text-center">
        <a href="{% url 'patient_list' %}" class="text-gray-600 hover:text-gray-800 hover:underline">
            Cancel and return to list
        </a>
    </div>
</div>

<!-- Form styling moved to static/css/style.css -->
{% endblock content %}